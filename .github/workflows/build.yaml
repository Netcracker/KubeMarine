name: Build Artifacts
on:
  push:
    branches:
      - '**'

jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Build Docker Image
        run: docker build -t kubemarine --no-cache .
      - name: Run Selftest
        # selftest of image internally runs selftest of package
        run: docker run kubemarine selftest
  build-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Build Package via Docker
        run: |
          docker build -t kubemarine --build-arg BUILD_TYPE=package --no-cache .
          CONTAINER_ID=$(docker create kubemarine)
          docker cp "${CONTAINER_ID}:/opt/kubemarine/dist" dist
          docker rm -v "${CONTAINER_ID}"
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: package
          path: ./dist
          retention-days: 1

  build-binary:
    runs-on: ${{ matrix.target.os }}
    needs: build-package
    strategy:
      fail-fast: false
      matrix:
        target:
          - {os: windows-2022, arch: 'win64'}
          - {os: macos-11, arch: 'macos11-x86_64'}
          - {os: macos-11, arch: 'macos11-arm64'}
          - {os: ubuntu-latest, arch: 'linux-x86_64'}
        include:
          - executable_path: './dist/kubemarine'
          - target: {os: windows-2022, arch: 'win64'}
            executable_path: 'dist\kubemarine.exe'
          - target: {os: ubuntu-latest, arch: 'linux-x86_64'}
            build_cmd: >
              docker run -t -v $(pwd):/opt/app-root/src centos/python-38-centos7 bash -c
              'pip install --upgrade pip wheel setuptools &&
              pip install pyinstaller==5.8.0 dist/*.whl &&
              pip uninstall -y kubemarine &&
              pyinstaller kubemarine.spec --noconfirm'
          - target: {os: windows-2022, arch: 'win64'}
            build_cmd: |
              pip install pyinstaller==5.8.0 (get-item dist\*.whl).FullName
              pip uninstall -y kubemarine
              pyinstaller kubemarine.spec --noconfirm
          - target: {os: macos-11, arch: 'macos11-x86_64'}
            build_cmd: |
              ./macos11_build_prepare.sh x86_64
              pip install pyinstaller==5.8.0
              pyinstaller kubemarine.spec --noconfirm
          - target: {os: macos-11, arch: 'macos11-arm64'}
            build_cmd: |
              ./macos11_build_prepare.sh arm64
              pip install pyinstaller==5.8.0
              pyinstaller kubemarine.spec --noconfirm
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Download Package
        uses: actions/download-artifact@v3
        with:
          name: package
          path: ./dist

      - name: Build
        run: ${{ matrix.build_cmd }}
      - name: Run Selftest
        if: ${{ matrix.target.arch != 'macos11-arm64' }}
        run: ${{ matrix.executable_path }} selftest

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: kubemarine-${{ matrix.target.arch }}
          path: ${{ matrix.executable_path }}
          retention-days: 1
